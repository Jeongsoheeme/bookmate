# 좌석 선택 동시성 문제 해결 가이드

## 🎯 문제 상황: 동시성 문제란?

**상황:**

- 콘서트 예매 사이트에서 인기 좌석이 열렸어요
- 100명이 동시에 같은 좌석을 클릭했어요
- 그런데 시스템이 "아직 비어있네!"라고 생각해서 100명 모두에게 "예매 성공!"이라고 알려줬어요
- 하지만 실제로는 좌석은 1개뿐이에요!

**결과:**

- 😱 100명이 모두 같은 좌석을 예매했다고 생각함
- 😱 실제로는 1명만 예매되어야 하는데, 시스템이 혼란스러워함
- 😱 나중에 99명이 "왜 내 예매가 취소됐어?"라고 불만을 제기함

이것이 **동시성 문제**예요!

---

## 🔒 해결 방법: 락(Lock) 사용하기

### 락이란?

**비유:**

- 도서관에서 책을 빌릴 때, 다른 사람이 빌리지 못하도록 "예약 중" 표시를 붙이는 것과 같아요
- 화장실 문에 자물쇠를 걸어서 다른 사람이 들어오지 못하게 하는 것과 같아요

**프로그램에서:**

- 좌석을 선택하는 순간, 그 좌석에 "잠금" 표시를 붙여요
- 다른 사람이 같은 좌석을 선택하려고 하면 "이미 다른 사람이 선택 중입니다"라고 알려줘요
- 예매가 완료되거나 취소되면 잠금을 풀어요

---

## 📊 테스트 결과 비교

### 테스트 1: 락 없이 동시 예약 시도

**시나리오:**

- 5명이 동시에 같은 좌석(1열-1번)을 예매하려고 시도
- 락을 사용하지 않음

**결과:**

```
총 요청 수: 5개
성공한 예약: 3개 (또는 4개, 5개 - 불확실!)
실제 DB에 저장된 예약 수: 1개 (또는 2개 - 불확실!)

⚠️ 문제 발생!
- 여러 명이 "성공했다"고 생각했지만, 실제로는 1개만 저장됨
- 나머지 사람들은 나중에 예매가 취소됨
- 사용자 경험이 매우 나쁨
```

### 테스트 2: 락을 사용한 동시 예약 시도

**시나리오:**

- 5명이 동시에 같은 좌석(1열-2번)을 예매하려고 시도
- 락을 사용함

**결과:**

```
총 요청 수: 5개
성공한 예약: 1개 ✅
실패한 예약: 4개 ✅
실행 시간: 0.5초

✅ 성공!
- 정확히 1명만 예매 성공
- 나머지 4명은 즉시 "이미 선택된 좌석입니다"라는 메시지를 받음
- 사용자가 다른 좌석을 선택할 수 있음
- 사용자 경험이 좋음
```

---

## 🛠️ 코드에서 어떻게 작동하나요?

### 1. 좌석 잠금 API (`/seats/lock`)

```python
# 사용자가 좌석을 선택하면
POST /api/v1/tickets/seats/lock
{
  "event_id": 1,
  "schedule_id": 1,
  "seats": [{"row": "1열", "number": 1}]
}

# Redis에 잠금 표시를 붙임
# "seat_lock:12345" = "user_id:uuid" (2분 동안 유지)
```

### 2. 예약 생성 API (`/bookings`)

```python
# 예약을 생성할 때
POST /api/v1/tickets/bookings

# 1단계: Redis 락 확인
# - 이미 다른 사람이 잠금했으면 → 실패
# - 내가 잠금했거나 아무도 잠금 안 했으면 → 진행

# 2단계: 데이터베이스 락 (SELECT FOR UPDATE)
# - 데이터베이스 레벨에서도 한 번 더 확인
# - 정말 안전하게 보장

# 3단계: 예약 생성
# - 모든 것이 확인되면 예약 생성

# 4단계: 잠금 해제
# - 예약이 완료되면 잠금을 풀어줌
```

---

## 🧪 테스트 실행 방법

### 1. 필요한 것들

- Python 3.8 이상
- PostgreSQL 데이터베이스
- Redis 서버
- pytest 라이브러리

### 2. 테스트 실행

```bash
# backend 디렉토리로 이동
cd backend

# 테스트 실행
pytest tests/test_seat_concurrency.py -v -s

# 특정 테스트만 실행
pytest tests/test_seat_concurrency.py::test_concurrent_booking_with_lock -v -s
```

### 3. 테스트 결과 해석

**성공한 경우:**

```
테스트 2: 락을 사용한 동시 예약 시도
============================================================
총 요청 수: 5
성공한 예약: 1개
실패한 예약: 4개
✅ 성공: 락 덕분에 정확히 1명만 예매에 성공했습니다!
```

**실패한 경우 (락이 제대로 작동하지 않음):**

```
테스트 2: 락을 사용한 동시 예약 시도
============================================================
총 요청 수: 5
성공한 예약: 3개  ⚠️ 문제!
실패한 예약: 2개
❌ 실패: 락이 제대로 작동하지 않습니다!
```

---

## 📝 요약

### 락 없이 (문제 상황)

- ❌ 여러 명이 같은 좌석을 예매할 수 있음
- ❌ 나중에 예매가 취소되어 사용자가 화남
- ❌ 시스템이 혼란스러움

### 락 사용 (해결)

- ✅ 정확히 1명만 예매 성공
- ✅ 나머지는 즉시 알림을 받아 다른 좌석 선택 가능
- ✅ 시스템이 안정적으로 작동

---

## 🎓 배운 점

1. **동시성 문제**: 여러 사람이 동시에 같은 것을 선택할 때 발생하는 문제
2. **락(Lock)**: 한 사람이 사용 중일 때 다른 사람이 사용하지 못하게 막는 방법
3. **Redis**: 빠른 메모리 저장소로 락을 관리하는 데 사용
4. **데이터베이스 락**: 최종 보장을 위한 추가 안전장치

---

## 🔍 더 알아보기

- `backend/app/services/redis_service.py`: Redis 락 구현 코드
- `backend/app/api/v1/endpoints/tickets.py`: 좌석 잠금 및 예약 API
- `backend/docs/SEAT_LOCKING_ARCHITECTURE.md`: 아키텍처 상세 설명

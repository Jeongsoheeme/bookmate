# 동시성 테스트 실행 가이드

## 문제 해결: pytest 명령어를 찾을 수 없을 때

### 해결 방법

**가상환경을 활성화한 후 pytest를 실행하세요:**

```bash
# backend 디렉토리로 이동
cd backend

# 가상환경 활성화
source venv/bin/activate

# pytest 실행
pytest tests/test_seat_concurrency.py -v -s
```

또는 가상환경 내에서 직접:

```bash
cd backend
source venv/bin/activate
python -m pytest tests/test_seat_concurrency.py -v -s
```

---

## 테스트 실행 전 준비사항

### 1. PostgreSQL 데이터베이스 실행

테스트를 실행하려면 PostgreSQL이 실행 중이어야 합니다.

```bash
# PostgreSQL 실행 확인
pg_isready

# 또는 Docker로 실행 중인 경우
docker ps | grep postgres
```

### 2. Redis 서버 실행

Redis도 실행 중이어야 합니다.

```bash
# Redis 실행 확인
redis-cli ping
# 응답: PONG

# 또는 Docker로 실행 중인 경우
docker ps | grep redis
```

### 3. 환경 변수 설정

`.env` 파일에 다음 설정이 필요합니다:

```env
DATABASE_URL=postgresql://user:password@localhost:5432/bookmate
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
```

---

## 테스트 실행 방법

### 전체 테스트 실행

```bash
cd backend
source venv/bin/activate
pytest tests/test_seat_concurrency.py -v -s
```

### 특정 테스트만 실행

```bash
# 락 없이 동시 예약 테스트
pytest tests/test_seat_concurrency.py::test_concurrent_booking_without_lock -v -s

# 락을 사용한 동시 예약 테스트
pytest tests/test_seat_concurrency.py::test_concurrent_booking_with_lock -v -s

# 좌석 잠금 API 테스트
pytest tests/test_seat_concurrency.py::test_seat_lock_api -v -s
```

---

## 테스트가 실패하는 경우

### 1. 데이터베이스 연결 오류

**에러:**
```
psycopg2.OperationalError: connection to server at "localhost" failed
```

**해결:**
- PostgreSQL이 실행 중인지 확인
- `.env` 파일의 `DATABASE_URL`이 올바른지 확인
- 데이터베이스가 실제로 존재하는지 확인

### 2. Redis 연결 오류

**에러:**
```
redis.exceptions.ConnectionError: Error connecting to Redis
```

**해결:**
- Redis가 실행 중인지 확인
- `.env` 파일의 Redis 설정이 올바른지 확인

### 3. 테스트 데이터 정리 문제

테스트는 자동으로 데이터를 정리하지만, 실패 시 수동으로 정리해야 할 수 있습니다:

```sql
-- PostgreSQL에서 테스트 데이터 삭제
DELETE FROM bookings WHERE user_id IN (SELECT id FROM users WHERE email LIKE 'test_user_%@example.com');
DELETE FROM tickets WHERE event_id IN (SELECT id FROM events WHERE title LIKE 'Test Event%');
DELETE FROM users WHERE email LIKE 'test_user_%@example.com';
DELETE FROM events WHERE title LIKE 'Test Event%';
```

---

## 테스트 결과 해석

### 성공한 경우

```
테스트 2: 락을 사용한 동시 예약 시도
============================================================
총 요청 수: 5
성공한 예약: 1개 ✅
실패한 예약: 4개 ✅
✅ 성공: 락 덕분에 정확히 1명만 예매에 성공했습니다!
```

### 실패한 경우 (락이 작동하지 않음)

```
테스트 2: 락을 사용한 동시 예약 시도
============================================================
총 요청 수: 5
성공한 예약: 3개 ⚠️ 문제!
실패한 예약: 2개
❌ 실패: 락이 제대로 작동하지 않습니다!
```

---

## 간단한 테스트 (데이터베이스 없이)

데이터베이스 연결 없이 락 로직만 테스트하려면, 단위 테스트를 작성할 수 있습니다:

```python
# tests/test_redis_lock.py (예시)
def test_redis_lock_basic():
    """Redis 락 기본 동작 테스트"""
    ticket_id = 12345
    user_id = 1
    
    # 락 획득
    result1 = redis_service.try_lock_seat(ticket_id, user_id=user_id)
    assert result1 == True
    
    # 같은 좌석에 다시 락 시도 (실패해야 함)
    result2 = redis_service.try_lock_seat(ticket_id, user_id=2)
    assert result2 == False
    
    # 락 해제
    redis_service.unlock_seat(ticket_id)
    
    # 해제 후 다시 락 시도 (성공해야 함)
    result3 = redis_service.try_lock_seat(ticket_id, user_id=2)
    assert result3 == True
    
    # 정리
    redis_service.unlock_seat(ticket_id)
```

---

## 도움말

문제가 계속되면:
1. PostgreSQL과 Redis가 실행 중인지 확인
2. `.env` 파일의 설정이 올바른지 확인
3. 가상환경이 활성화되어 있는지 확인
4. 필요한 패키지가 설치되어 있는지 확인: `pip install -r requirements.txt`
